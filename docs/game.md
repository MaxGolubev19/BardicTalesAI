# game.py

Класс `Game` управляет игровым процессом, ведёт историю, обрабатывает ответы пользователя и генерирует новые эпизоды с помощью AI.

## Класс `Game`

### Атрибуты  
- `HISTORY_SIZE (int)`: Количество сохранённых последних эпизодов игры.  
- `user_id (int)`: Telegram-id пользователя.  
- `user_name (str)`: Имя пользователя.  
- `language (str)`: Текущий язык игры.  
- `write (Write)`: Объект для записи истории.
- `prompt_editor (PromptEditor)`: Объект для управления промтами и шаблонами.  
- `future (str | None)`: План будущего развития истории.  
- `past (list)`: Список последних эпизодов игры.  
- `info (str | None)`: Основная информация об игре.  
- `past_relevant (bool)`: Флаг актуальности истории игры.  
- `info_relevant (bool)`: Флаг актуальности основной информации игры.  
- `count (int)`: Счётчик эпизодов игры.  
- `wait (bool)`: Флаг ожидания завершения обработки хода.  
- `current_task (asyncio.Task | None)`: Текущая задача AI.  

### Методы  

#### `__init__(self, user_id: int, user_name: str, language: str)`  
Инициализирует игру.  

---

#### `set_language(self, language: str) -> Game`  
Устанавливает новый язык игры.

---

#### `set_incognito(self, incognito: bool) -> Game`  
Включает или отключает инкогнито-режим (не записывает историю).  

---

#### `reset(self) -> Game`  
Создаёт новый объект `Game` для сброса текущего состояния.  

---

#### `async set_settings(self, settings: str) -> Game`  
Устанавливает описание игры.  

---

#### `async set_random_settings(self) -> Game`  
Выбирает случайное описание игры.  

---

#### `async set_start_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для генерации первого эпизода.  

---

#### `async set_move_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для генерации нового эпизода.  

---

#### `async set_future_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для генерации плана развития истории.  

---

#### `async set_past_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для генерации краткого содержания предыдущих событий.  

---

#### `async set_create_info_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для создания основной информации об игре.  

---

#### `async set_update_info_prompt(self, prompt: str) -> Game`  
Устанавливает пользовательский промт для обновления основной информации об игре.  

---

#### `async start(self) -> str`  
Запускает новую игру, создаёт первый эпизод.  

---

#### `async move(self, answer: str) -> str`  
Обрабатывает ответ пользователя и генерирует новый эпизод.  

---

#### `async other(self, now: str) -> None`  
Генерирует план развития истории (только для первого эпизода), обновляет историю событий и основную информацию об игре. 

---

#### `async generate_future(self, now: str) -> None`  
Генерирует план развития истории.  

---

#### `async generate_past(self, now: str) -> None`  
Создаёт краткое содержание предыдущих событий и обновляет сохранённые эпизоды.

---

#### `async generate_info(self, now: str) -> None`  
Генерирует или обновляет основную информацию об игре.  

---

#### `async createTaskAI(self, messages: list, typeRequest: str, role: str) -> str`  
Запускает асинхронный запрос к AI для генерации текста.  

---

#### `get_patterns(self) -> Module`  
Возвращает модуль с шаблонными сообщениями на текущем языке.  

---

#### `get_info(self) -> str`  
Возвращает текущую основную информацию об игре.  

---

#### `get_future(self) -> str`  
Возвращает план развития истории.  

---

#### `__getstate__(self) -> dict`  
Подготовка объекта к сериализации (исключает `current_task`).  

---

#### `__setstate__(self, state: dict) -> None`  
Восстанавливает объект после десериализации.

